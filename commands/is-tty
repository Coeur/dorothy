#!/usr/bin/env bash

function is_tty() (
	source "$DOROTHY/sources/bash.bash"

	# =====================================
	# Arguments

	function help {
		cat <<-EOF >/dev/stderr
			ABOUT:
			Checks if the environment actually has a TTY available.
			This is important, as otherwise calls to [tty] will result in "not a tty" being output.

			USAGE:
			is-tty [...options]

			OPTIONS:
			--verbose
			    If provided, output more information.
		EOF
		if test "$#" -ne 0; then
			echo-error "$@"
		fi
		return 22 # EINVAL 22 Invalid argument
	}

	# process
	local item option_quiet=''
	option_quiet="$(echo-quiet --no-env "$option_quiet" -- "$@")"
	while test "$#" -ne 0; do
		item="$1"
		shift
		case "$item" in
		'--help' | '-h') help ;;
		'--no-quiet'* | '--quiet'* | '--no-verbose'* | '--verbose'*) ;; # handled by echo-quiet
		'--'*) help "An unrecognised flag was provided: $item" ;;
		*) help "An unrecognised argument was provided: $item" ;;
		esac
	done

	# =====================================
	# Action

	if test "$option_quiet" = 'no'; then
		set -x
		(test -t 0 && echo "success status = $?") || echo "failure status = $?"
		(test -t 1 && echo "success status = $?") || echo "failure status = $?"
		(test -t 2 && echo "success status = $?") || echo "failure status = $?"
		(test -c '/dev/tty' && echo "success status = $?") || echo "failure status = $?"
		echo "NO_TTY = ${NO_TTY-}"
		echo "TTY = ${TTY-}"
		(ps -p "$$" -o tty= && echo "success status = $?") || echo "failure status = $?"
		(exec </dev/tty && echo "success status = $?") || echo "failure status = $?"
		set +x

		# RUNNING ON MACOS
		# > is-tty --debug
		# < 'test' '-t' '0' >
		# </ 'test' '-t' '0' >[0]
		# < 'test' '-t' '1' >
		# </ 'test' '-t' '1' >[0]
		# < 'test' '-t' '2' >
		# </ 'test' '-t' '2' >[0]
		# < 'test' '-c' '/dev/tty' >
		# </ 'test' '-c' '/dev/tty' >[0]
		# < 'echo' '' >
		# </ 'echo' '' >[0]
		# < 'echo' '' >
		# </ 'echo' '' >[0]
		# < 'ps' '-p' '24266' '-o' 'tty=' >
		# ttys004
		# </ 'ps' '-p' '24266' '-o' 'tty=' >[0]
		# + exec
		# + echo 0
		# 0
		# + set -e +x

		# RUNNING ON MACOS VIA CRON
		# < 'test' '-t' '0' >
		# </ 'test' '-t' '0' >[1]
		# < 'test' '-t' '1' >
		# </ 'test' '-t' '1' >[1]
		# < 'test' '-t' '2' >
		# </ 'test' '-t' '2' >[1]
		# < 'test' '-c' '/dev/tty' >
		# </ 'test' '-c' '/dev/tty' >[0]
		# < 'echo' '' >
		# </ 'echo' '' >[0]
		# < 'echo' '' >
		# </ 'echo' '' >[0]
		# < 'ps' '-p' '19201' '-o' 'tty=' >
		# ??
		# </ 'ps' '-p' '19201' '-o' 'tty=' >[0]
		# + exec
		# /Users/balupton/.local/share/dorothy/commands/is-tty: line 15: /dev/tty: Device not configured
		# ++ EXIT_STATUS=1
		# ++ test is_tty = eval_capture_wrapper
		# ++ test -n is_tty
		# ++ return 1
	fi

	# [-t 0] check stdin exists, [tty -s] is deprecated in favour of this
	# [-t 1] check stdout exists
	# [-t 2] check stderr exists
	# [-c '/dev/tty'] check tty exists, however it lies: crons still produce [line 228: /dev/tty: Device not configured]
	# [ps -p] check as that actually works
	test -t 0 -a -t 1 -a -t 2 -a -c '/dev/tty' -a "${NO_TTY-}" != 'yes' -a "${TTY-}" != 'no'

	# inside an [apk] check as alpine returns the following:
	# ps: unrecognized option: p
	# BusyBox v1.36.1 (2023-07-27 17:12:24 UTC) multi-call binary.
	# Usage: ps [-o COL1,COL2=HEADER] [-T]
	# Show list of processes
	# -o COL1,COL2=HEADER	Select columns for display
	if command-missing apk; then
		[[ "$(ps -p "$$" -o tty=)" != '?'* ]]
	fi

	# @todo handle NO_TTY=yes and TTY=no properly we need is-affirmative or echo-affirmative to not be as silly as they are
	# is-affirmative fails if given only an empty string, and echo-affirmative outputs to stderr that must be silenced
	#  -a "$(echo-affirmative "${NO_TTY-}" || :)" != 'yes' -a "$(echo-non-affirmative "${TTY-}" || :)" != 'yes'
	# if test -n "${NO_TTY-}"; then
	# 	! is-affirmative "$NO_TTY"
	# fi
	# if test -n "${TTY-}"; then
	# 	! is-affirmative "$TTY"
	# fi
)

# fire if invoked standalone
if test "$0" = "${BASH_SOURCE[0]}"; then
	is_tty "$@"
fi
